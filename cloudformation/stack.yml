AWSTemplateFormatVersion: "2010-09-09"
Description: >
  CI/CD deployed Glue ETL job triggered by S3 uploads using Lambda
  with environment-based isolation and consolidated S3 buckets.

# -------------------------------------------------
# PARAMETERS
# -------------------------------------------------
Parameters:
  Environment:
    Type: String
    AllowedValues: [dev, test, prod]
    Description: Deployment environment

# -------------------------------------------------
# MAPPINGS
# -------------------------------------------------
Mappings:
  EnvToBucket:
    dev:
      DataBucket: project-dev-ci-cd-21166
    test:
      DataBucket: project-test-ci-cd-21166
    prod:
      DataBucket: project-prod-ci-cd-21166

# -------------------------------------------------
# RESOURCES
# -------------------------------------------------
Resources:

# -------------------------------------------------
# GLUE EXECUTION ROLE
# -------------------------------------------------
  GlueExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub glue-execution-role-${Environment}
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: glue.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSGlueServiceRole
      Policies:
        - PolicyName: GlueS3AccessPolicy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:DeleteObject
                  - s3:ListBucket
                Resource:
                  - !Sub
                    - arn:aws:s3:::${Bucket}
                    - Bucket: !FindInMap [EnvToBucket, !Ref Environment, DataBucket]
                  - !Sub
                    - arn:aws:s3:::${Bucket}/*
                    - Bucket: !FindInMap [EnvToBucket, !Ref Environment, DataBucket]

# -------------------------------------------------
# GLUE JOB
# -------------------------------------------------
  GlueJob:
    Type: AWS::Glue::Job
    Properties:
      Name: !Sub glue-log-aggregation-${Environment}
      Role: !GetAtt GlueExecutionRole.Arn
      GlueVersion: "4.0"
      WorkerType: G.1X
      NumberOfWorkers: 2
      Command:
        Name: glueetl
        ScriptLocation: !Sub
          - s3://${Bucket}/scripts/glue/log_aggregation_job.py
          - Bucket: !FindInMap [EnvToBucket, !Ref Environment, DataBucket]
      DefaultArguments:
        --ENV: !Ref Environment
        --INPUT_PATH: !Sub
          - s3://${Bucket}/raw/
          - Bucket: !FindInMap [EnvToBucket, !Ref Environment, DataBucket]
        --OUTPUT_PATH: !Sub
          - s3://${Bucket}/clean/
          - Bucket: !FindInMap [EnvToBucket, !Ref Environment, DataBucket]
        --job-bookmark-option: job-bookmark-enable
        --enable-metrics: ""
        --enable-continuous-cloudwatch-log: "true"
      ExecutionProperty:
        MaxConcurrentRuns: 1

# -------------------------------------------------
# LAMBDA EXECUTION ROLE
# -------------------------------------------------
  GlueTriggerLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub glue-trigger-lambda-role-${Environment}
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: LambdaGlueAndS3Policy
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - glue:StartJobRun
                Resource: !Sub arn:aws:glue:${AWS::Region}:${AWS::AccountId}:job/glue-log-aggregation-${Environment}
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:ListBucket
                Resource:
                  - !Sub
                    - arn:aws:s3:::${Bucket}
                    - Bucket: !FindInMap [EnvToBucket, !Ref Environment, DataBucket]
                  - !Sub
                    - arn:aws:s3:::${Bucket}/*
                    - Bucket: !FindInMap [EnvToBucket, !Ref Environment, DataBucket]

# -------------------------------------------------
# LAMBDA FUNCTION – S3 → GLUE TRIGGER
# -------------------------------------------------
  GlueTriggerLambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub glue-trigger-${Environment}
      Runtime: python3.10
      Handler: trigger.lambda_handler
      Role: !GetAtt GlueTriggerLambdaRole.Arn
      Timeout: 60
      Code:
        S3Bucket: !FindInMap [EnvToBucket, !Ref Environment, DataBucket]
        S3Key: scripts/lambda/trigger.py
      Environment:
        Variables:
          ENV: !Ref Environment
          GLUE_JOB_NAME: !Ref GlueJob
          DATA_BUCKET: !FindInMap [EnvToBucket, !Ref Environment, DataBucket]

# -------------------------------------------------
# PERMISSION FOR S3 TO INVOKE GLUE TRIGGER LAMBDA
# -------------------------------------------------
  AllowS3InvokeGlueLambda:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref GlueTriggerLambda
      Action: lambda:InvokeFunction
      Principal: s3.amazonaws.com
      SourceArn: !Sub
        - arn:aws:s3:::${Bucket}
        - Bucket: !FindInMap [EnvToBucket, !Ref Environment, DataBucket]

# -------------------------------------------------
# IAM ROLE FOR S3 NOTIFICATION CUSTOM RESOURCE
# -------------------------------------------------
  S3NotificationRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub s3-notification-role-${Environment}
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: AllowS3NotificationUpdate
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetBucketNotification
                  - s3:PutBucketNotification
                Resource: !Sub
                  - arn:aws:s3:::${Bucket}
                  - Bucket: !FindInMap [EnvToBucket, !Ref Environment, DataBucket]

# -------------------------------------------------
# CUSTOM RESOURCE LAMBDA – S3 NOTIFICATION
# -------------------------------------------------
  S3NotificationLambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub s3-notification-${Environment}
      Runtime: python3.10
      Handler: index.handler
      Role: !GetAtt S3NotificationRole.Arn
      Timeout: 60
      Code:
        ZipFile: |
          import json
          import boto3
          import urllib.request

          def send(event, context, status, reason=None):
              response = {
                  "Status": status,
                  "Reason": reason or "OK",
                  "PhysicalResourceId": context.log_stream_name,
                  "StackId": event["StackId"],
                  "RequestId": event["RequestId"],
                  "LogicalResourceId": event["LogicalResourceId"],
                  "Data": {}
              }
              req = urllib.request.Request(
                  event["ResponseURL"],
                  data=json.dumps(response).encode(),
                  headers={"Content-Type": ""},
                  method="PUT"
              )
              urllib.request.urlopen(req)

          def handler(event, context):
              s3 = boto3.client("s3")
              bucket = event["ResourceProperties"]["Bucket"]
              lambda_arn = event["ResourceProperties"]["LambdaArn"]

              try:
                  if event["RequestType"] in ["Create", "Update"]:
                      s3.put_bucket_notification_configuration(
                          Bucket=bucket,
                          NotificationConfiguration={
                              "LambdaFunctionConfigurations": [
                                  {
                                      "LambdaFunctionArn": lambda_arn,
                                      "Events": ["s3:ObjectCreated:*"],
                                      "Filter": {
                                          "Key": {
                                              "FilterRules": [
                                                  {"Name": "prefix", "Value": "raw/"}
                                              ]
                                          }
                                      }
                                  }
                              ]
                          }
                      )
                  elif event["RequestType"] == "Delete":
                      s3.put_bucket_notification_configuration(
                          Bucket=bucket,
                          NotificationConfiguration={}
                      )
                  send(event, context, "SUCCESS")
              except Exception as e:
                  send(event, context, "FAILED", str(e))

# -------------------------------------------------
# ATTACH S3 NOTIFICATION (CUSTOM RESOURCE)
# -------------------------------------------------
  AttachS3Notification:
    Type: Custom::AttachS3Notification
    DependsOn: AllowS3InvokeGlueLambda
    Properties:
      ServiceToken: !GetAtt S3NotificationLambda.Arn
      Bucket: !FindInMap [EnvToBucket, !Ref Environment, DataBucket]
      LambdaArn: !GetAtt GlueTriggerLambda.Arn

# -------------------------------------------------
# OUTPUTS
# -------------------------------------------------
Outputs:
  Environment:
    Value: !Ref Environment

  DataBucket:
    Value: !FindInMap [EnvToBucket, !Ref Environment, DataBucket]

  GlueJobName:
    Value: !Ref GlueJob

  LambdaFunctionName:
    Value: !Ref GlueTriggerLambda
